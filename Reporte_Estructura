import pandas as pd
import numpy as np
import os
from pathlib import Path
import json
import re

# ================================================================
# CONFIGURACIÃ“N
# ================================================================
CARPETA = r"C:\Users\leovu\Downloads\Datos Descargados\Procesados"       # Cambiar
N_PREVIEW_ROWS = 7                     # Filas a mostrar por hoja
HEADER_THRESHOLD = 0.50                # % mÃ­nimo de columnas no vacÃ­as para considerar encabezado
SIMILITUD_MINIMA = 0.35                # % mÃ­nimo para considerar dos tablas "relacionables"
SALIDA_EXCEL = "Reporte_Estructura_2.0.xlsx"
SALIDA_JSON = "Reporte_Estructura_2.0.json"

# ================================================================
# DETECTAR ENCABEZADO REAL
# ================================================================
def detectar_encabezado(df):
    for idx, row in df.iterrows():
        non_empty = row.notna().sum()
        if non_empty / len(row) >= HEADER_THRESHOLD:
            return idx
    return 0  # fallback


# ================================================================
# DETECTAR POSIBLES CLAVES
# ================================================================
def detectar_claves(columnas):
    claves = []
    patrones = [
        r"id", r"ident", r"document", r"autoriz", r"fact", r"cups",
        r"cod", r"num", r"nro", r"registro", r"orden"
    ]
    for col in columnas:
        col_l = col.lower()
        if any(re.search(p, col_l) for p in patrones):
            claves.append(col)
    return claves


# ================================================================
# MEDIR SIMILITUD ENTRE CONJUNTOS DE COLUMNAS
# ================================================================
def similitud_columnas(cols1, cols2):
    s1 = set([c.lower() for c in cols1])
    s2 = set([c.lower() for c in cols2])
    inter = len(s1.intersection(s2))
    union = len(s1.union(s2))
    if union == 0:
        return 0
    return inter / union


# ================================================================
# SCAN GLOBAL
# ================================================================
def analizar_archivos():
    estructura = []      # para Excel final
    metadata = {}        # para JSON
    hojas_info = []      # para matriz de similitud

    print("\n=== ðŸš€ INICIANDO ANÃLISIS AVANZADO (v2.0) ===\n")

    for archivo in Path(CARPETA).glob("*.xlsx"):
        print(f"ðŸ“˜ Archivo: {archivo.name}")
        try:
            xls = pd.ExcelFile(archivo)
        except Exception as e:
            print(f"  âŒ Error leyendo archivo: {e}")
            continue

        metadata[archivo.name] = {}

        for hoja in xls.sheet_names:
            print(f"   â†’ Hoja: {hoja}")

            try:
                df_temp = pd.read_excel(archivo, sheet_name=hoja, nrows=20, header=None)
                header_row = detectar_encabezado(df_temp)
                df = pd.read_excel(archivo, sheet_name=hoja, header=header_row)
            except Exception as e:
                print(f"      âŒ Error procesando hoja: {e}")
                continue

            columnas = df.columns.tolist()
            claves_posibles = detectar_claves(columnas)
            preview = df.head(N_PREVIEW_ROWS)

            # Guardar para Excel
            estructura.append({
                "Archivo": archivo.name,
                "Hoja": hoja,
                "Encabezado_detectado": header_row,
                "Columnas": columnas,
                "Preview": preview
            })

            # Guardar para similitudes
            hojas_info.append({
                "Archivo": archivo.name,
                "Hoja": hoja,
                "Columnas": columnas
            })

            # Guardar para JSON
            metadata[archivo.name][hoja] = {
                "encabezado_detectado": header_row,
                "columnas": columnas,
                "claves_probables": claves_posibles
            }

    # ================================================================
    # CALCULAR MATRIZ DE SIMILITUD ENTRE TODAS LAS HOJAS
    # ================================================================
    matriz_similitud = []

    print("\n=== ðŸ” CALCULANDO MATRIZ DE SIMILITUD ===\n")

    for i in range(len(hojas_info)):
        for j in range(i + 1, len(hojas_info)):
            h1 = hojas_info[i]
            h2 = hojas_info[j]
            sim = similitud_columnas(h1["Columnas"], h2["Columnas"])
            if sim >= SIMILITUD_MINIMA:
                matriz_similitud.append({
                    "Archivo 1": h1["Archivo"],
                    "Hoja 1": h1["Hoja"],
                    "Archivo 2": h2["Archivo"],
                    "Hoja 2": h2["Hoja"],
                    "Similitud": round(sim, 3)
                })

    print("=== âœ” MATRIZ COMPLETA ===\n")

    return estructura, metadata, matriz_similitud


# ================================================================
# EXPORTACIÃ“N A EXCEL
# ================================================================
def exportar_excel(estructura, matriz):
    print(f"ðŸ“¤ Exportando reporte Excel â†’ {SALIDA_EXCEL}")

    with pd.ExcelWriter(SALIDA_EXCEL, engine="openpyxl") as writer:
        # Hoja con metadata general
        meta = pd.DataFrame([{
            "Archivo": item["Archivo"],
            "Hoja": item["Hoja"],
            "Encabezado_detectado": item["Encabezado_detectado"],
            "Columnas": ", ".join(item["Columnas"])
        } for item in estructura])

        meta.to_excel(writer, sheet_name="Resumen_Estructura", index=False)

        # Hoja de similitud
        if matriz:
            pd.DataFrame(matriz).to_excel(writer, sheet_name="Relaciones Encontradas", index=False)

        # Previews por hoja
        for i, item in enumerate(estructura):
            nombre_hoja = f"{i+1}_{item['Hoja'][:20]}"
            item["Preview"].to_excel(writer, sheet_name=nombre_hoja, index=False)

    print("âœ” Archivo Excel generado.\n")


# ================================================================
# EXPORTACIÃ“N JSON
# ================================================================
def exportar_json(metadata):
    print(f"ðŸ“¤ Exportando metadata JSON â†’ {SALIDA_JSON}")
    with open(SALIDA_JSON, "w", encoding="utf-8") as f:
        json.dump(metadata, f, indent=4, ensure_ascii=False)
    print("âœ” Archivo JSON generado.\n")


# ================================================================
# MAIN
# ================================================================
if __name__ == "__main__":
    estructura, metadata, matriz = analizar_archivos()
    exportar_excel(estructura, matriz)
    exportar_json(metadata)
    print("\nðŸŽ‰ PROCESO COMPLETO â€” VersiÃ³n 2.0 lista.\n")
