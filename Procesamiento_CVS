import pandas as pd
import tkinter as tk
from tkinter import filedialog, messagebox
import os
import csv

def detectar_separador(ruta):
    """Detecta automáticamente ; , | o tab. Si no detecta, retorna None."""
    posibles = [",", ";", "|", "\t"]
    with open(ruta, "r", encoding="utf-8", errors="ignore") as f:
        linea = f.readline()

    # Probar cada separador y contar columnas
    mejor_sep = None
    max_cols = 0

    for sep in posibles:
        cols = len(linea.split(sep))
        if cols > max_cols:
            max_cols = cols
            mejor_sep = sep
    
    # Si el "mejor" separador genera 1 sola columna → no es válido
    if max_cols <= 1:
        return None

    return mejor_sep

def procesar_archivo(ruta_archivo):
    print(f"\nProcesando archivo: {ruta_archivo}")

    separador = detectar_separador(ruta_archivo)

    if separador:
        print(f"Separador detectado: '{separador}' → Leyendo como CSV normal.")
        df = pd.read_csv(ruta_archivo, sep=separador, engine="python")
        return df
    else:
        print("⚠ No se detectó separador. Procesando mediante algoritmo inteligente.")

        # Leer todo el archivo como texto
        with open(ruta_archivo, "r", encoding="utf-8", errors="ignore") as f:
            contenido = f.read()

        # Normalizar espacios
        contenido = " ".join(contenido.split())

        # Intento 1: Dividir por coma+espacio
        if ", " in contenido:
            columnas = contenido.split(", ")
        else:
            # Último recurso: dividir por coma
            columnas = contenido.split(",")

        # Convertir a DataFrame con UNA FILA
        df = pd.DataFrame([columnas])
        df.columns = [f"Col_{i+1}" for i in range(len(df.columns))]

        return df

def seleccionar_y_procesar():
    root = tk.Tk()
    root.withdraw()

    rutas = filedialog.askopenfilenames(
        title="Seleccione archivos CSV o TXT",
        filetypes=[("CSV", "*.csv"), ("Texto", "*.txt"), ("Todos", "*.*")]
    )

    if not rutas:
        messagebox.showwarning("Sin archivos", "No se seleccionó ningún archivo.")
        return

    carpeta_salida = os.path.join(os.path.dirname(rutas[0]), "Procesados")
    os.makedirs(carpeta_salida, exist_ok=True)

    for ruta in rutas:
        df = procesar_archivo(ruta)

        # LIMITAR columnas a máximo 16.000 para Excel
        if df.shape[1] > 16384:
            print(f"⚠ Advertencia: archivo tenía {df.shape[1]} columnas.")
            df = df.iloc[:, :16384]
            print("→ Se recortó a 16.384 columnas para compatibilidad con Excel.")

        # Exportar Excel
        nombre = os.path.splitext(os.path.basename(ruta))[0]
        salida = os.path.join(carpeta_salida, f"{nombre}_procesado.xlsx")
        df.to_excel(salida, index=False)

        print(f"Archivo exportado a: {salida}")

    messagebox.showinfo("COMPLETADO", "Todos los archivos fueron procesados exitosamente.")

if __name__ == "__main__":
    seleccionar_y_procesar()
