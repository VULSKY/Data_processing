import pandas as pd
from tkinter import Tk
from tkinter.filedialog import askopenfilenames
import unicodedata

def quitar_tildes(s: str) -> str:
    return ''.join(
        c for c in unicodedata.normalize('NFKD', s) if not unicodedata.combining(c)
    )

def convertir_excel_mayusculas(convertir_tildes=False):
    # Oculta la ventana principal de Tkinter
    Tk().withdraw()

    print("Seleccione los archivos Excel...")
    archivos = askopenfilenames(
        title="Selecciona uno o más archivos Excel",
        filetypes=[("Archivos Excel", "*.xlsx *.xls")]
    )

    if not archivos:
        print("No seleccionaste archivos.")
        return

    print(f"\n{len(archivos)} archivo(s) seleccionado(s)\n")

    for archivo in archivos:
        print(f"Procesando: {archivo}")
        
        # Leer todas las hojas
        xls = pd.ExcelFile(archivo)
        hojas = xls.sheet_names
        print(f"  Hojas encontradas: {hojas}")

        # Generar nombre del archivo de salida
        if archivo.endswith('.xlsx'):
            archivo_salida = archivo.replace(".xlsx", "_MAYUS.xlsx")
        else:
            archivo_salida = archivo.replace(".xls", "_MAYUS.xlsx")

        with pd.ExcelWriter(archivo_salida, engine="openpyxl") as writer:
            for hoja in hojas:
                print(f"    Procesando hoja: {hoja}")
                df = pd.read_excel(archivo, sheet_name=hoja)

                # 1) Encabezados: convertir a mayúsculas y strip
                new_cols = []
                for col in df.columns:
                    if isinstance(col, str):
                        col2 = col.strip()
                        col2 = col2.upper()
                        if convertir_tildes:
                            col2 = quitar_tildes(col2)
                        new_cols.append(col2)
                    else:
                        new_cols.append(col)
                df.columns = new_cols

                # 2) Celdas: convertir columnas de texto a mayúsculas
                for col in df.select_dtypes(include=["object"]).columns:
                    df[col] = df[col].map(lambda x: x.strip().upper() if isinstance(x, str) else x)

                    if convertir_tildes:
                        df[col] = df[col].map(lambda x: quitar_tildes(x) if isinstance(x, str) else x)

                # Escribir hoja
                df.to_excel(writer, sheet_name=hoja, index=False)

        print(f"  ✓ Archivo generado: {archivo_salida}\n")

    print("¡Proceso completado!")


if __name__ == "__main__":
    convertir_excel_mayusculas(convertir_tildes=False)